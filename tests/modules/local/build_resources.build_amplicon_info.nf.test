nextflow_process {

    name "Test Process BUILD_AMPLICON_INFO"
    script "modules/local/build_resources.nf"
    process "BUILD_AMPLICON_INFO"

    test("Build all pools should run without failures") {

        when {
            params {
                pools = "D1 R1 R2"
                amplicon_info_paths = "${projectDir}/panel_information/D1.1/D1.1_amplicon_info.tsv ${projectDir}/panel_information/R1.2/R1.2_amplicon_info.tsv ${projectDir}/panel_information/R2.1/R2.1_amplicon_info.tsv"
                amplicon_info_output = "amplicon_info_test.tsv"
            }
            process {
                """
                input[0] = params.pools
                input[1] = params.amplicon_info_paths
                input[2] = params.amplicon_info_output
                """
            }
        }

        then {
            assert process.success
            assert process.out.amplicon_info
            assert path(process.out.amplicon_info.get(0)).md5 == "12a4d58807138684bbd3bf39497ec28e"
        }

    }

    test("Build single pool should run without failures") {

        when {
            params {
                pools = "R1"
                amplicon_info_paths = "${projectDir}/panel_information/R1.2/R1.2_amplicon_info.tsv"
                amplicon_info_output = "amplicon_info_test.tsv"
            }
            process {
                """
                input[0] = params.pools
                input[1] = params.amplicon_info_paths
                input[2] = params.amplicon_info_output
                """
            }
        }

        then {
            assert process.success
            assert process.out.amplicon_info
            assert path(process.out.amplicon_info.get(0)).md5 == "789ae2fb564ca55f1ce692119fba3110"
        }

    }


    test("Build crazy name should run without failures") {

        when {
            params {
                pools = "Something"
                amplicon_info_paths = "${projectDir}/panel_information/R1.2/R1.2_amplicon_info.tsv"
                amplicon_info_output = "amplicon_info_test.tsv"
            }
            process {
                """
                input[0] = params.pools
                input[1] = params.amplicon_info_paths
                input[2] = params.amplicon_info_output
                """
            }
        }

        then {
            assert process.success
            assert process.out.amplicon_info
            assert path(process.out.amplicon_info.get(0)).md5 == "56c21df597782f756cc2b444a7e8be21"
        }

    }

    test("Build with missing columns should fail") {

        when {
            params {
                pools = "R2"
                amplicon_info_paths = "${projectDir}/tests/example_data/amplicon_info_missing_cols.tsv"
                amplicon_info_output = "amplicon_info_test.tsv"
            }
            process {
                """
                input[0] = params.pools
                input[1] = params.amplicon_info_paths
                input[2] = params.amplicon_info_output
                """
            }
        }

        then {
            assert process.failed
            assert process.errorReport.contains("tests/example_data/amplicon_info_missing_cols.tsv' is missing required columns: ['target_name', 'chrom', 'insert_start', 'insert_end', 'fwd_primer']")
        }

    }

}