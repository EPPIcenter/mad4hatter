nextflow_process {

    name "Test Process BUILD_RESMARKER_INFO"
    script "modules/local/build_resources.nf"
    process "BUILD_RESMARKER_INFO"

    test("Should run without failures on full mad4hatter pools") {

        when {
            params {
                amplicon_info = "${projectDir}/tests/example_data/multi_pool_amplicon_info.tsv"
                principal_resmarkers = "${projectDir}/tests/example_data/principal_resistance_marker_info_table.tsv"
                resmarker_info_output_path = "output"
            }
            process {
                """
                input[0] = params.amplicon_info
                input[1] = params.principal_resmarkers
                input[2] = params.resmarker_info_output_path
                """
            }
        }

        then {
            assert process.success
            assert process.out.resmarker_info
            assert path(process.out.resmarker_info.get(0)).md5 == "71f76c81d69aa11fa663e298f004c675"
        }

    }


    test("Running with no overlap should run successfully and produce null output") {

        when {
            params {
                amplicon_info = "${projectDir}/panel_information/D1.1/D1.1_amplicon_info.tsv"
                principal_resmarkers = "${projectDir}/tests/example_data/principal_resistance_marker_info_table.tsv"
                resmarker_info_output_path = "output"
            }
            process {
                """
                input[0] = params.amplicon_info
                input[1] = params.principal_resmarkers
                input[2] = params.resmarker_info_output_path
                """
            }
        }

        then {
            assert process.success
            assert !process.out.resmarker_info
        }

    }

    test("Running with multiple tiled targets should run successfully") {

        when {
            params {
                amplicon_info = "${projectDir}/tests/example_data/dummy_amplicon_info_with_resmarker_multiple_targets_per_marker.tsv"
                principal_resmarkers = "${projectDir}/tests/example_data/dummy_resmarker_info.tsv"
                resmarker_info_output_path = "output"
            }
            process {
                """
                input[0] = params.amplicon_info
                input[1] = params.principal_resmarkers
                input[2] = params.resmarker_info_output_path
                """
            }
        }

        then {
            assert process.success
            assert process.out.resmarker_info
            assert path(process.out.resmarker_info.get(0)).md5 == "3dec10fc9cc311d369a8aaa4565df32b"
        }

    }
    
    test("Running with marker at edge of target example should run successfully") {

        when {
            params {
                amplicon_info = "${projectDir}/tests/example_data/dummy_amplicon_info_with_resmarker_at_edge.tsv"
                principal_resmarkers = "${projectDir}/tests/example_data/dummy_resmarker_info.tsv"
                resmarker_info_output_path = "output"
            }
            process {
                """
                input[0] = params.amplicon_info
                input[1] = params.principal_resmarkers
                input[2] = params.resmarker_info_output_path
                """
            }
        }

        then {
            assert process.success
            assert process.out.resmarker_info
            assert path(process.out.resmarker_info.get(0)).md5 == "b9e9d75166a5a13540de908a04915d1e"
        }

    }
}

