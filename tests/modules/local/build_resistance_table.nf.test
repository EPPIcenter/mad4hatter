nextflow_process {

    name "Test Process BUILD_RESISTANCE_TABLE"
    script "modules/local/build_resistance_table.nf"
    process "BUILD_RESISTANCE_TABLE"

    test("Should run without failures") {

        when {
            params {
                alleledata = "${projectDir}/tests/example_data/test_resmarker_allele_data.txt"
                alignment_data = "${projectDir}/tests/example_data/test_resmarker_alignments.txt"
                resmarkers = "${projectDir}/tests/example_data/test_resmarker_info.txt"
                refseq = "${projectDir}/tests/example_data/test_resmarker_reference.fasta"
            }
            process {
                """
                input[0] = params.alleledata
                input[1] = params.alignment_data
                input[2] = params.resmarkers
                input[3] = params.refseq
                """
            }
        }

        then {
            assert process.success

            assert process.out.resmarkers
            assert path(process.out.resmarkers.get(0)).md5 == "a7a986edfbdf91685e24d9ff314b2187"

            assert process.out.resmarkers_by_locus
            assert path(process.out.resmarkers_by_locus.get(0)).md5 == "05879ab17d01ac88a5e841734bd303f2"

            assert process.out.microhaps
            assert path(process.out.microhaps.get(0)).md5 == "70e3120fc9eb85c3dd208a9e8a30642b"

            assert process.out.new_mutations
            assert path(process.out.new_mutations.get(0)).md5 == "97a26fcb8984717c9e2a3b66355fdede"

        }

    }

    test("Should run with empty outputs when no resmarkers in allele table") {

        when {
            params {
                alleledata = "${projectDir}/tests/example_data/allele_data.txt"
                alignment_data = "${projectDir}/tests/example_data/alignments.pseudocigar.txt"
                resmarkers = "${projectDir}/tests/example_data/test_resmarker_info.txt"
                refseq = "${projectDir}/tests/example_data/test_resmarker_reference.fasta"
            }
            process {
                """
                input[0] = params.alleledata
                input[1] = params.alignment_data
                input[2] = params.resmarkers
                input[3] = params.refseq
                """
            }
        }

        then {
            assert process.success

            assert process.out.resmarkers
            assert path(process.out.resmarkers.get(0)).md5 == "a7ff5dd3a268a3cfb1fa5724aa1c045d"

            assert process.out.resmarkers_by_locus
            assert path(process.out.resmarkers_by_locus.get(0)).md5 == "e429d667bb0e56586a8bdb25bf22244c"

            assert process.out.microhaps
            assert path(process.out.microhaps.get(0)).md5 == "e27a80a0c303e01df1085fc169068093"

            assert process.out.new_mutations
            assert path(process.out.new_mutations.get(0)).md5 == "1df635f64bde6061ddaca98dbd226506"
        }

    }

}