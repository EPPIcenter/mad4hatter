nextflow_process {

    name "Test Process BUILD_RESISTANCE_TABLE"
    script "modules/local/build_resistance_table.nf"
    process "BUILD_RESISTANCE_TABLE"

    test("Should run without failures") {

        when {
            params {
                alleledata = "${projectDir}/tests/example_data/test_resmarker_allele_data.txt"
                alignment_data = "${projectDir}/tests/example_data/test_resmarker_alignments.txt"
                resmarkers = "${projectDir}/tests/example_data/test_resmarker_info.txt"
                refseq = "${projectDir}/tests/example_data/test_resmarker_reference.fasta"
            }
            process {
                """
                input[0] = params.alleledata
                input[1] = params.alignment_data
                input[2] = params.resmarkers
                input[3] = params.refseq
                """
            }
        }

        then {
            assert process.success

            assert process.out.resmarkers
            assert path(process.out.resmarkers.get(0)).md5 == "79b326cf78f07ebc07656b0aca2a2ab9"

            assert process.out.resmarkers_by_locus
            assert path(process.out.resmarkers_by_locus.get(0)).md5 == "857c21f65cbcde613a613a14015841f6"

            assert process.out.microhaps
            assert path(process.out.microhaps.get(0)).md5 == "6e09680f7ac2d16eaee73620c59b3b1b"

            assert process.out.new_mutations
            assert path(process.out.new_mutations.get(0)).md5 == "0117f9728399730b3238c3bf7bc1c033"

        }

    }

    test("Should run with empty outputs when no resmarkers in allele table") {

        when {
            params {
                alleledata = "${projectDir}/tests/example_data/allele_data.txt"
                alignment_data = "${projectDir}/tests/example_data/alignments.pseudocigar.txt"
                resmarkers = "${projectDir}/tests/example_data/test_resmarker_info.txt"
                refseq = "${projectDir}/tests/example_data/test_resmarker_reference.fasta"
            }
            process {
                """
                input[0] = params.alleledata
                input[1] = params.alignment_data
                input[2] = params.resmarkers
                input[3] = params.refseq
                """
            }
        }

        then {
            assert process.success

            assert process.out.resmarkers
            assert path(process.out.resmarkers.get(0)).md5 == "849183bad94addb9103560b05e691a76"

            assert process.out.resmarkers_by_locus
            assert path(process.out.resmarkers_by_locus.get(0)).md5 == "e32c1947acf01c0e9826eb2fba9c1d7e"

            assert process.out.microhaps
            assert path(process.out.microhaps.get(0)).md5 == "a9aa17a6274b0c8f515e80f2d0848b74"

            assert process.out.new_mutations
            assert path(process.out.new_mutations.get(0)).md5 == "2c0bd8aac24eb68331d27242cbedf0af"
        }

    }

}