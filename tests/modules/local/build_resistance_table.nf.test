nextflow_process {

    name "Test Process BUILD_RESISTANCE_TABLE"
    script "modules/local/build_resistance_table.nf"
    process "BUILD_RESISTANCE_TABLE"

    test("Should run without failures") {

        when {
            params {
                alleledata = "${projectDir}/tests/example_data/test_resmarker_allele_data.txt"
                alignment_data = "${projectDir}/tests/example_data/test_resmarker_alignments.txt"
                resmarkers = "${projectDir}/tests/example_data/test_resmarker_info.txt"
                refseq = "${projectDir}/tests/example_data/test_resmarker_reference.fasta"
            }
            process {
                """
                input[0] = params.alleledata
                input[1] = params.alignment_data
                input[2] = params.resmarkers
                input[3] = params.refseq
                """
            }
        }

        then {
            assert process.success

            assert process.out.resmarkers
            assert path(process.out.resmarkers.get(0)).md5 == "16286b7cee3c53fa03e68f72323973d0"

            assert process.out.resmarkers_by_locus
            assert path(process.out.resmarkers_by_locus.get(0)).md5 == "7297599313cbf8c6050bb51e12882611"

            assert process.out.microhaps
            assert path(process.out.microhaps.get(0)).md5 == "5fd7b708ba35e55435dc1c0a1886e727"

            assert process.out.new_mutations
            assert path(process.out.new_mutations.get(0)).md5 == "6b9f5177a9387f06d913dbecd52c7b20"

        }

    }

    test("Should run with empty outputs when no resmarkers in allele table") {

        when {
            params {
                alleledata = "${projectDir}/tests/example_data/allele_data.txt"
                alignment_data = "${projectDir}/tests/example_data/alignments.pseudocigar.txt"
                resmarkers = "${projectDir}/tests/example_data/test_resmarker_info.txt"
                refseq = "${projectDir}/tests/example_data/test_resmarker_reference.fasta"
            }
            process {
                """
                input[0] = params.alleledata
                input[1] = params.alignment_data
                input[2] = params.resmarkers
                input[3] = params.refseq
                """
            }
        }

        then {
            assert process.success

            assert process.out.resmarkers
            assert path(process.out.resmarkers.get(0)).md5 == "8da176d5456916dfc6fda591384cf46d"

            assert process.out.resmarkers_by_locus
            assert path(process.out.resmarkers_by_locus.get(0)).md5 == "9cf3cfd34f504484326e5c253f739752"

            assert process.out.microhaps
            assert path(process.out.microhaps.get(0)).md5 == "c27b4f331d1e45881b449384e5174c9b"

            assert process.out.new_mutations
            assert path(process.out.new_mutations.get(0)).md5 == "f33ec9a6639e7ce48acfc97f1540572a"
        }

    }

}