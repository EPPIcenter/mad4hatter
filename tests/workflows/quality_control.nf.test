nextflow_workflow {

    name "Test Workflow QUALITY_CONTROL"
    script "workflows/quality_control.nf"
    workflow "QUALITY_CONTROL"

    test("Should run without postprocessing") {

        when {
            params {
                sample_file1 = "${projectDir}/tests/example_data/N3D7100Kb_S103.SAMPLEsummary.txt"
                sample_file2 = "${projectDir}/tests/example_data/N3D710ka_S56.SAMPLEsummary.txt"
                sample_file3 = "${projectDir}/tests/example_data/SRR26819135_S1_L001.SAMPLEsummary.txt"
                amplicon_file1 = "${projectDir}/tests/example_data/N3D7100Kb_S103.AMPLICONsummary.txt"
                amplicon_file2 = "${projectDir}/tests/example_data/N3D710ka_S56.AMPLICONsummary.txt"
                amplicon_file3 = "${projectDir}/tests/example_data/SRR26819135_S1_L001.AMPLICONsummary.txt"
            }
            workflow {
                """
                input[0] = Channel.of(
                    file(params.sample_file1),
                    file(params.sample_file2),
                    file(params.sample_file3)
                )
                input[1] = Channel.of(
                    file(params.amplicon_file1),
                    file(params.amplicon_file2),
                    file(params.amplicon_file3)
                )
                input[2] = null
                input[3] = null
                """
            }
        }

        then {
            assert workflow.success
            assert workflow.out.sample_coverage
            assert workflow.out.amplicon_coverage
            assert path(workflow.out.sample_coverage.get(0)).md5 == "5be6f0346ea876679ccc646251583e3f"
            assert path(workflow.out.amplicon_coverage.get(0)).md5 == "73695b40aaf9830570f4f55a6a9f3a1c"
        }

    }

    test("Should run with postprocessing") {

        when {
            params {
                sample_file1 = "${projectDir}/tests/example_data/N3D7100Kb_S103.SAMPLEsummary.txt"
                sample_file2 = "${projectDir}/tests/example_data/N3D710ka_S56.SAMPLEsummary.txt"
                sample_file3 = "${projectDir}/tests/example_data/SRR26819135_S1_L001.SAMPLEsummary.txt"
                amplicon_file1 = "${projectDir}/tests/example_data/N3D7100Kb_S103.AMPLICONsummary.txt"
                amplicon_file2 = "${projectDir}/tests/example_data/N3D710ka_S56.AMPLICONsummary.txt"
                amplicon_file3 = "${projectDir}/tests/example_data/SRR26819135_S1_L001.AMPLICONsummary.txt"
                alleledata = "${projectDir}/tests/example_data/allele_data.txt"
                clusters = "${projectDir}/tests/example_data/dada2.clusters.txt"
            }
            workflow {
                """
                input[0] = Channel.of(
                    file(params.sample_file1),
                    file(params.sample_file2),
                    file(params.sample_file3)
                )
                input[1] = Channel.of(
                    file(params.amplicon_file1),
                    file(params.amplicon_file2),
                    file(params.amplicon_file3)
                )
                input[2] = file(params.alleledata)
                input[3] = file(params.clusters)
                """
            }
        }

        then {
            assert workflow.success
            assert workflow.out.sample_coverage
            assert workflow.out.amplicon_coverage
            assert path(workflow.out.sample_coverage.get(0)).md5 == "11733857dc8d75fbc0debe1168560fae"
            assert path(workflow.out.amplicon_coverage.get(0)).md5 == "637da14a5ec87115737cc5a6eb064f29"
        }

    }

}