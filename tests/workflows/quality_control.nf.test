nextflow_workflow {

    name "Test Workflow QUALITY_CONTROL"
    script "workflows/quality_control.nf"
    workflow "QUALITY_CONTROL"

    test("Should run without postprocessing") {

        when {
            params {
                sample_file1 = "${projectDir}/tests/example_data/N3D7100Kb_S103.SAMPLEsummary.txt"
                sample_file2 = "${projectDir}/tests/example_data/N3D710ka_S56.SAMPLEsummary.txt"
                sample_file3 = "${projectDir}/tests/example_data/SRR26819135_S1_L001.SAMPLEsummary.txt"
                amplicon_file1 = "${projectDir}/tests/example_data/N3D7100Kb_S103.AMPLICONsummary.txt"
                amplicon_file2 = "${projectDir}/tests/example_data/N3D710ka_S56.AMPLICONsummary.txt"
                amplicon_file3 = "${projectDir}/tests/example_data/SRR26819135_S1_L001.AMPLICONsummary.txt"
            }
            workflow {
                """
                input[0] = Channel.of(
                    file(params.sample_file1),
                    file(params.sample_file2),
                    file(params.sample_file3)
                )
                input[1] = Channel.of(
                    file(params.amplicon_file1),
                    file(params.amplicon_file2),
                    file(params.amplicon_file3)
                )
                input[2] = null
                input[3] = null
                """
            }
        }

        then {
            assert workflow.success
            assert workflow.out.sample_coverage
            assert workflow.out.amplicon_coverage
            assert path(workflow.out.sample_coverage.get(0)).md5 == "3ccbcdc873b904fed77aeea8606322b9"
            assert path(workflow.out.amplicon_coverage.get(0)).md5 == "6e4ecd2939db1982d9cd746cc2711503"
        }

    }

    test("Should run with postprocessing") {

        when {
            params {
                sample_file1 = "${projectDir}/tests/example_data/N3D7100Kb_S103.SAMPLEsummary.txt"
                sample_file2 = "${projectDir}/tests/example_data/N3D710ka_S56.SAMPLEsummary.txt"
                sample_file3 = "${projectDir}/tests/example_data/SRR26819135_S1_L001.SAMPLEsummary.txt"
                amplicon_file1 = "${projectDir}/tests/example_data/N3D7100Kb_S103.AMPLICONsummary.txt"
                amplicon_file2 = "${projectDir}/tests/example_data/N3D710ka_S56.AMPLICONsummary.txt"
                amplicon_file3 = "${projectDir}/tests/example_data/SRR26819135_S1_L001.AMPLICONsummary.txt"
                alleledata = "${projectDir}/tests/example_data/allele_data.txt"
                clusters = "${projectDir}/tests/example_data/dada2.clusters.txt"
            }
            workflow {
                """
                input[0] = Channel.of(
                    file(params.sample_file1),
                    file(params.sample_file2),
                    file(params.sample_file3)
                )
                input[1] = Channel.of(
                    file(params.amplicon_file1),
                    file(params.amplicon_file2),
                    file(params.amplicon_file3)
                )
                input[2] = file(params.alleledata)
                input[3] = file(params.clusters)
                """
            }
        }

        then {
            assert workflow.success
            assert workflow.out.sample_coverage
            assert workflow.out.amplicon_coverage
            assert path(workflow.out.sample_coverage.get(0)).md5 == "c5877466581b344bfd3714308b94c621"
            assert path(workflow.out.amplicon_coverage.get(0)).md5 == "443c4acd9b6b94f08a665b7981bb58e0"
        }

    }

}