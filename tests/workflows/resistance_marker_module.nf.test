nextflow_workflow {

    name "Test Workflow RESISTANCE_MARKER_MODULE"
    script "workflows/resistance_marker_module.nf"
    workflow "RESISTANCE_MARKER_MODULE"

    test("Should run without failures when building resmarker_info") {

        when {
            params {
                principal_resmarkers = "${projectDir}/tests/example_data/principal_resistance_marker_info_table.tsv"
                resmarker_info = null
                amplicon_info = "${projectDir}/tests/example_data/multi_pool_amplicon_info.tsv"
                allele_data = "${projectDir}/tests/example_data/allele_data.txt"
                alignment_data = "${projectDir}/tests/example_data/masked.alignments.txt"
                reference = "${projectDir}/tests/example_data/multi_pool_targeted_reference.fasta"
            }
            workflow {
                """
                input[0] = file(params.amplicon_info)
                input[1] = file(params.allele_data)
                input[2] = file(params.alignment_data)
                input[3] = file(params.reference)
                """
            }
        }

        then {
            assert workflow.success

            assert workflow.out.resmarkers
            assert workflow.out.resmarkers_by_locus
            assert workflow.out.microhaps
            assert workflow.out.new_mutations

            assert path(workflow.out.resmarkers.get(0)).md5 == "2c061752d5b2d197bc4b7ba82d5edf9f"
            assert path(workflow.out.resmarkers_by_locus.get(0)).md5 == "0f7e5c461a042b0dbaf75aaf09f16fee"
            assert path(workflow.out.microhaps.get(0)).md5 == "db601d145f2fb21c6775a6702465a2b3"
            assert path(workflow.out.new_mutations.get(0)).md5 == "15f468ab0f7bb6129dd1028761e110ad"
        }

    }

    test("Should run without failures when resmarker_info is provided") {

        when {
            params {
                resmarker_info = "${projectDir}/tests/example_data/test_resmarker_info.txt"
                amplicon_info = "unused_file_path"
                allele_data = "${projectDir}/tests/example_data/test_resmarker_allele_data.txt"
                alignment_data = "${projectDir}/tests/example_data/test_resmarker_alignments.txt"
                reference = "${projectDir}/tests/example_data/test_resmarker_reference.fasta"
            }
            workflow {
                """
                input[0] = file(params.amplicon_info)
                input[1] = file(params.allele_data)
                input[2] = file(params.alignment_data)
                input[3] = file(params.reference)
                """
            }
        }

        then {
            assert workflow.success

            assert workflow.out.resmarkers
            assert workflow.out.resmarkers_by_locus
            assert workflow.out.microhaps
            assert workflow.out.new_mutations

            assert path(workflow.out.resmarkers.get(0)).md5 == "a7a986edfbdf91685e24d9ff314b2187"
            assert path(workflow.out.resmarkers_by_locus.get(0)).md5 == "05879ab17d01ac88a5e841734bd303f2"
            assert path(workflow.out.microhaps.get(0)).md5 == "70e3120fc9eb85c3dd208a9e8a30642b"
            assert path(workflow.out.new_mutations.get(0)).md5 == "97a26fcb8984717c9e2a3b66355fdede"
        }

    }

}
