nextflow_workflow {

    name "Test Workflow DENOISE_AMPLICONS_2"
    script "workflows/denoise_amplicons_2.nf"
    workflow "DENOISE_AMPLICONS_2"

    test("Should run without failures without refseq_fasta") {

        when {
            params {
                pools = 'D1,R1,R2'
                just_concatenate = true
                refseq_fasta = null
                masked_fasta = null
                mask_tandem_repeats = true
                mask_homopolymers = true

                amplicon_info = "${projectDir}/tests/example_data/multi_pool_amplicon_info.tsv"
                denoise_ch = "${projectDir}/tests/example_data/subset_dada2.clusters.txt"
            }
            workflow {
                """
                input[0] = params.amplicon_info
                input[1] = params.denoise_ch
                """
            }
        }

        then {
            assert workflow.success

            assert workflow.out.masked_pseudocigar
            assert path(workflow.out.masked_pseudocigar.get(0)).md5 == "a6e6c4bfe0dc6e1bdd292f73228dd388"

            assert workflow.out.reference_ch
            assert path(workflow.out.reference_ch.get(0)).md5 == "1b9e32ab96d2083941eafea727d83f48"

            assert workflow.out.aligned_asv_table
            assert path(workflow.out.aligned_asv_table.get(0)).md5 == "401c3726aa1126161df05c384743cc6b"

            assert workflow.trace.tasks().size() == 9
        }

    }

    test("Should run without failures with refseq_fasta") {

        when {
            params {
                just_concatenate = true
                refseq_fasta = "${projectDir}/tests/example_data/multi_pool_targeted_reference.fasta"
                masked_fasta = null
                mask_tandem_repeats = true
                mask_homopolymers = true

                amplicon_info = "${projectDir}/tests/example_data/multi_pool_amplicon_info.tsv"
                denoise_ch = "${projectDir}/tests/example_data/subset_dada2.clusters.txt"
            }
            workflow {
                """
                input[0] = params.amplicon_info
                input[1] = params.denoise_ch
                """
            }
        }

        then {
            assert workflow.success

            assert workflow.out.masked_pseudocigar
            assert path(workflow.out.masked_pseudocigar.get(0)).md5 == "a6e6c4bfe0dc6e1bdd292f73228dd388"

            assert workflow.out.reference_ch
            assert path(workflow.out.reference_ch.get(0)).md5 == "1b9e32ab96d2083941eafea727d83f48"

            assert workflow.out.aligned_asv_table
            assert path(workflow.out.aligned_asv_table.get(0)).md5 == "401c3726aa1126161df05c384743cc6b"

            assert workflow.trace.tasks().size() == 8
        }

    }

    test("Should run without failures without concatenating") {

        when {
            params {
                just_concatenate = false
                refseq_fasta = "${projectDir}/tests/example_data/multi_pool_targeted_reference.fasta"
                masked_fasta = null
                mask_tandem_repeats = true
                mask_homopolymers = true

                amplicon_info = "${projectDir}/tests/example_data/multi_pool_amplicon_info.tsv"
                denoise_ch = "${projectDir}/tests/example_data/subset_dada2.clusters.txt"
            }
            workflow {
                """
                input[0] = params.amplicon_info
                input[1] = params.denoise_ch
                """
            }
        }

        then {
            assert workflow.success

            assert workflow.out.masked_pseudocigar
            assert path(workflow.out.masked_pseudocigar.get(0)).md5 == "a6e6c4bfe0dc6e1bdd292f73228dd388"

            assert workflow.out.reference_ch
            assert path(workflow.out.reference_ch.get(0)).md5 == "1b9e32ab96d2083941eafea727d83f48"

            assert workflow.out.aligned_asv_table
            assert path(workflow.out.aligned_asv_table.get(0)).md5 == "401c3726aa1126161df05c384743cc6b"

            assert workflow.trace.tasks().size() == 7
        }

    }
}