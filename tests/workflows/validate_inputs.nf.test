nextflow_workflow {

    name "Test Workflow VALIDATE_INPUTS"
    script "workflows/validate_inputs.nf"
    workflow "VALIDATE_INPUTS"

    test("Running complete workflow checks should pass") {

        when {
            params {
                workflow_name='complete'
                pools='D1.1,R1,R2'

                readDIR='${projectDir}/tests/example_data/'
                sequencer='miseq'
            }
        }

        then {
            assert workflow.success
        }

    }

    test("Running qc workflow checks should pass") {

        when {
            params {
                workflow_name='QC'
                pools='D1.1,R1,R2'

                readDIR='${projectDir}/tests/example_data/'
                sequencer='miseq'
            }
        }

        then {
            assert workflow.success
        }

    }

    test("Running complete workflow checks should pass with upper case workflow name") {

        when {
            params {
                workflow_name='COMPLETE'
                pools='D1.1,R1,R2'

                readDIR='${projectDir}/tests/example_data/'
                sequencer='miseq'
            }
        }

        then {
            assert workflow.success
        }

    }

    test("Running checks should fail with invalid workflow name") {

        when {
            params {
                workflow_name='invalid'
                pools='D1.1,R1,R2'

                readDIR='${projectDir}/tests/example_data/'
                sequencer='miseq'
            }
        }

        then {
            assert workflow.failed
            assert workflow.stdout.contains("ERROR ~ Invalid workflow specified: invalid. Allowed workflows are: qc, complete, postprocessing.")
        }

    }

    test("Running complete workflow checks should fail with missing readDIR") {

        when {
            params {
                workflow_name='complete'
                pools='D1.1,R1,R2'

                readDIR=null
                sequencer='miseq'
            }
        }

        then {
            assert workflow.failed
            assert workflow.stdout.contains("ERROR ~ `--readDIR` must be specified but is missing.")
        }

    }

    test("Running complete workflow checks should fail with invalid pool name and no amplicon info set") {

        when {
            params {
                workflow_name='complete'
                pools='D1.1,R1,bad_pool ,bad_pool2'

                readDIR='${projectDir}/tests/example_data/'
                sequencer='miseq'
                genome = '${projectDir}/tests/example_data/chrom_one_genome.fasta'
            }
        }

        then {
            assert workflow.failed
            assert workflow.stdout.contains("ERROR ~ Pools were not found in configuration: bad_pool, bad_pool2. `--amplicon_info` and either `--refseq_fasta` or `--genome` must be provided when using bespoke pools.")
        }

    }
    
    test("Running postprocessing workflow checks should fail with invalid pool name and no genome or refseq set") {

        when {
            params {
                workflow_name='postprocessing'
                pools='D1.1,R1,bad_pool ,bad_pool2'
                amplicon_info = '${projectDir}/tests/example_data/multi_pool_amplicon_info.tsv'

                readDIR='${projectDir}/tests/example_data/'
                sequencer='miseq'
            }
        }

        then {
            assert workflow.failed
            assert workflow.stdout.contains("ERROR ~ Pools were not found in configuration: bad_pool, bad_pool2. `--amplicon_info` and either `--refseq_fasta` or `--genome` must be provided when using bespoke pools.")
        }

    }
    test("Running qc workflow checks should fail with invalid pool name and no amplicon info") {

        when {
            params {
                workflow_name='qc'
                pools='D1.1,R1,bad_pool ,bad_pool2'

                readDIR='${projectDir}/tests/example_data/'
                sequencer='miseq'
            }
        }

        then {
            assert workflow.failed
            assert workflow.stdout.contains("ERROR ~ Pools were not found in configuration: bad_pool, bad_pool2. `--amplicon_info` must be specified when using bespoke pools.")
        }

    }
    test("Running qc workflow with invalid pools and amplicon info should pass") {

        when {
            params {
                workflow_name='qc'
                pools='D1.1,R1,badpool'

                readDIR='${projectDir}/tests/example_data/'
                sequencer='miseq'
                amplicon_info = '${projectDir}/tests/example_data/multi_pool_amplicon_info.tsv'
            }
        }

        then {
            assert workflow.success
        }

    }
    test("Running complete workflow with invalid pools and amplicon info and genome should pass") {

        when {
            params {
                workflow_name='complete'
                pools='D1.1,R1,badpool'

                readDIR='${projectDir}/tests/example_data/'
                sequencer='miseq'
                amplicon_info = '${projectDir}/tests/example_data/multi_pool_amplicon_info.tsv'
                genome = '${projectDir}/tests/example_data/chrom_one_genome.fasta'
            }
        }

        then {
            assert workflow.success
        }

    }
    test("Running postprocessing workflow checks should pass") {

        when {
            params {
                workflow_name='postprocessing'
                pools='D1.1,R1,R2'

                denoised_asvs='${projectDir}/tests/example_data/'
            }
        }

        then {
            assert workflow.success
        }

    }
}